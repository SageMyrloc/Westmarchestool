<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Detail | The Torchbearers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/character-portrait-card.css">
</head>
<body class="bg-dark text-light">
    <!-- Navbar -->
    <app-navbar active="characters"></app-navbar>

    <!-- Main Content -->
    <div class="container-fluid mt-4 px-4">
        <!-- Page Header -->
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a href="/characters.html" class="btn btn-outline-warning">← Back</a>
                <h1 class="text-warning mb-0" id="characterName">Loading...</h1>
            </div>
            <div class="btn-group">
                <button class="btn btn-warning" id="exportBtn">Export JSON</button>
                <button class="btn btn-outline-danger" id="deleteBtn">Delete Character</button>
            </div>
        </div>

        <!-- Character Content -->
        <div class="row">
            <!-- Left: Character Portrait -->
            <div class="col-md-3">
                <div id="characterPortrait"></div>
            </div>

            <!-- Right: Character Details -->
            <div class="col-md-9">
                <div class="card bg-black border-secondary mb-4">
                    <div class="card-body">
                        <h3 class="text-warning mb-3">Character Information</h3>
                        <div id="characterDetails">
                            <p class="text-center text-muted">Loading character data...</p>
                        </div>
                    </div>
                </div>

                <!-- Placeholder for more sections -->
                <div class="card bg-black border-secondary">
                    <div class="card-body">
                        <h3 class="text-warning mb-3">Inventory</h3>
                        <p class="text-light">Inventory system coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/components/app-navbar.js"></script>
    <script src="/js/components/character-portrait-card.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Get character ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id');

        if (!characterId) {
            window.location.href = '/characters.html';
        }

        // Load character data
        async function loadCharacter() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/characters/${characterId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load character');
                }

                const character = await response.json();
                displayCharacter(character);

            } catch (error) {
                console.error('Error loading character:', error);
                document.getElementById('characterDetails').innerHTML = `
                    <p class="text-danger">Failed to load character. <a href="/characters.html">Return to characters</a></p>
                `;
            }
        }

        function displayCharacter(character) {
            // Update page title
            document.getElementById('characterName').textContent = character.name;

            // Display portrait
            const portraitDiv = document.getElementById('characterPortrait');
            const portraitUrl = `${API_BASE_URL}/api/Characters/${character.id}/portrait`;

            portraitDiv.innerHTML = `
            <character-portrait-card
                name="${character.name}"
                character-class="${character.class}"
                level="${character.level}"
                portrait-url="${portraitUrl}">
            </character-portrait-card>
`;

            // Display details
            const detailsDiv = document.getElementById('characterDetails');
            detailsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p class="text-light"><strong class="text-warning">Class:</strong> ${character.class}</p>
                        <p class="text-light"><strong class="text-warning">Level:</strong> ${character.level}</p>
                        <p class="text-light"><strong class="text-warning">Ancestry:</strong> ${character.ancestry}</p>
                        <p class="text-light"><strong class="text-warning">Background:</strong> ${character.background}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="text-light"><strong class="text-warning">Experience:</strong> ${character.experience} XP</p>
                        <p class="text-light"><strong class="text-warning">Status:</strong> ${character.status}</p>
                        <p class="text-light"><strong class="text-warning">Money:</strong></p>
                        <ul class="text-light">
                            <li>Platinum: ${character.money.pp}</li>
                            <li>Gold: ${character.money.gp}</li>
                            <li>Silver: ${character.money.sp}</li>
                            <li>Copper: ${character.money.cp}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Export JSON button
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/characters/${characterId}/json`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const json = await response.text();

                // Download as file
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `character-${characterId}.json`;
                a.click();

            } catch (error) {
                alert('Failed to export character');
            }
        });

        // Delete button
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete this character? This cannot be undone.')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/characters/${characterId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('Character deleted successfully');
                    window.location.href = '/characters.html';
                } else {
                    alert('Failed to delete character');
                }
            } catch (error) {
                alert('Failed to delete character');
            }
        });

        // Load character on page load
        loadCharacter();
    </script>
</body>
</html>